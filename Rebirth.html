<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rebirth | 90 Days</title>
    <style>
        /* DESIGN SYSTEM */
        :root {
            --bg-color: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --accent-color: #5D7285;
            --danger: #FF3B30;
            --radius-lg: 20px;
            --radius-sm: 12px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-family);
            margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }
        #app-container {
            flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px;
            width: 100%; max-width: 600px; margin: 0 auto;
        }
        h1 { font-size: 28px; font-weight: 700; margin: 0 0 10px 0; }
        h2 { font-size: 22px; font-weight: 600; margin: 0 0 20px 0; }
        h3 { font-size: 14px; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 10px; }
        .card {
            background: var(--card-bg); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        button {
            background: var(--accent-color); color: white; border: none; padding: 16px; border-radius: var(--radius-sm);
            font-size: 16px; font-weight: 600; width: 100%; margin-bottom: 10px;
        }
        button.outline { background: transparent; border: 1px solid #CCC; color: var(--text-primary); }
        button.text-only { background: transparent; color: var(--text-secondary); padding: 10px; font-weight: 400; font-size: 14px; }
        input, textarea, select {
            width: 100%; padding: 14px; border: 1px solid #E5E5E5; border-radius: var(--radius-sm);
            font-size: 16px; background: #FAFAFA; margin-bottom: 10px; -webkit-appearance: none;
        }
        .navbar {
            position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background: rgba(255,255,255,0.98);
            border-top: 1px solid #E5E5E5; display: flex; justify-content: space-around; align-items: center;
            padding-bottom: 15px; z-index: 9999;
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; color: #999; font-size: 10px; }
        .nav-item.active { color: var(--accent-color); font-weight: 700; }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }
        .view { display: none; }
        .view.active { display: block; }
        .check-item { display: flex; align-items: center; padding: 14px 0; border-bottom: 1px solid #F5F5F7; }
        .checkbox { width: 24px; height: 24px; border: 2px solid #C7C7CC; border-radius: 6px; margin-right: 15px; display:flex; align-items:center; justify-content:center;}
        .checkbox.checked { background: var(--accent-color); border-color: var(--accent-color); }
        .checkbox.checked::after { content: '‚úì'; color: white; font-size: 14px; }
        .strikethrough { text-decoration: line-through; opacity: 0.4; }
        .hidden { display: none !important; }
        .grid-container { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; }
        .grid-cell { aspect-ratio: 1; background: #EAEAEA; border-radius: 2px; }
        #breakdown-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #F5F5F7; z-index: 10000;
            display: none; flex-direction: column; justify-content: center; align-items: center; padding: 30px; text-align: center;
        }
    </style>

    <script>
        // Define app globally immediately
        window.app = {
            state: { startDate: null, identity: "", days: {} },
            nonNegs: ["Shower", "10m Walk", "Speech Practice", "Start Work"],

            init: function() {
                try {
                    const stored = localStorage.getItem('rebirth_v3');
                    if (stored) this.state = JSON.parse(stored);
                    else this.state.startDate = new Date().toISOString().split('T')[0];
                    
                    this.ensureToday();
                    this.renderAll();
                    
                    // Attach Identity Listener
                    const idInput = document.getElementById('identity-input');
                    if(idInput) {
                        idInput.value = this.state.identity;
                        idInput.oninput = (e) => { this.state.identity = e.target.value; this.save(); };
                    }
                } catch(e) { alert("Error loading: " + e.message); }
            },

            ensureToday: function() {
                const t = new Date().toISOString().split('T')[0];
                if (!this.state.days[t]) this.state.days[t] = { tasks: [], nn: {}, journal: "" };
            },

            save: function() {
                localStorage.setItem('rebirth_v3', JSON.stringify(this.state));
            },

            getToday: function() { return new Date().toISOString().split('T')[0]; },

            // NAVIGATION
            navigate: function(viewId) {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                document.getElementById('view-' + viewId).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const nav = document.querySelector(`.nav-item[onclick*="${viewId}"]`);
                if(nav) nav.classList.add('active');
                if(viewId === 'grid') this.renderGrid();
                if(viewId === 'journal') this.renderJournal();
            },

            // ACTIONS
            toggleBreakdown: function(show) {
                document.getElementById('breakdown-overlay').style.display = show ? 'flex' : 'none';
            },

            toggleSettings: function() {
                document.getElementById('settings-area').classList.toggle('hidden');
            },

            updateDate: function(val) {
                if(val) { this.state.startDate = val; this.save(); this.renderAll(); }
            },

            // TASKS
            toggleNN: function(name) {
                const t = this.getToday();
                const cur = this.state.days[t].nn[name];
                this.state.days[t].nn[name] = !cur;
                this.save(); this.renderToday();
            },

            toggleTaskForm: function() {
                document.getElementById('task-form').classList.toggle('hidden');
            },

            addTask: function() {
                const desc = document.getElementById('new-task-desc').value;
                if(!desc) return;
                const t = this.getToday();
                if(this.state.days[t].tasks.length >= 7) return alert("Max 7 tasks.");
                this.state.days[t].tasks.push({ desc, done: false });
                document.getElementById('new-task-desc').value = "";
                this.toggleTaskForm();
                this.save(); this.renderToday();
            },

            toggleTask: function(idx) {
                const t = this.getToday();
                this.state.days[t].tasks[idx].done = !this.state.days[t].tasks[idx].done;
                this.save(); this.renderToday();
            },

            deleteTask: function(idx) {
                const t = this.getToday();
                this.state.days[t].tasks.splice(idx, 1);
                this.save(); this.renderToday();
            },

            saveJournal: function(txt) {
                const t = this.getToday();
                this.state.days[t].journal = txt;
                this.save();
            },

            // RENDERING
            renderAll: function() {
                this.renderHome();
                this.renderToday();
                this.renderJournal();
            },

            renderHome: function() {
                const start = new Date(this.state.startDate);
                const diff = Math.floor((new Date() - start) / (86400000)) + 1;
                const day = diff > 0 ? diff : 1;
                document.getElementById('day-header').innerText = `Day ${day} / 90`;
                document.getElementById('progress-fill').style.width = Math.min((day/90)*100, 100) + "%";
                document.getElementById('date-picker').value = this.state.startDate;
            },

            renderToday: function() {
                const t = this.getToday();
                const d = this.state.days[t];
                
                // NN
                let h = "";
                this.nonNegs.forEach(n => {
                    const done = d.nn[n];
                    h += `<div class="check-item" onclick="window.app.toggleNN('${n}')">
                        <div class="checkbox ${done?'checked':''}"></div><span class="${done?'strikethrough':''}">${n}</span>
                    </div>`;
                });
                document.getElementById('nn-list').innerHTML = h;

                // Tasks
                h = "";
                if(!d.tasks.length) h = "<p class='subtext' style='text-align:center'>No tasks.</p>";
                d.tasks.forEach((k, i) => {
                    h += `<div class="check-item">
                        <div class="checkbox ${k.done?'checked':''}" onclick="window.app.toggleTask(${i})"></div>
                        <div style="flex:1" class="${k.done?'strikethrough':''}">${k.desc}</div>
                        <span onclick="window.app.deleteTask(${i})" style="color:red; padding:10px">√ó</span>
                    </div>`;
                });
                document.getElementById('task-list').innerHTML = h;
            },

            renderJournal: function() {
                const t = this.getToday();
                document.getElementById('j-text').value = this.state.days[t]?.journal || "";
                let h = "";
                Object.keys(this.state.days).sort().reverse().forEach(k => {
                    if(k !== t && this.state.days[k].journal) 
                        h += `<div class="card" style="padding:15px"><b style="font-size:12px;color:#999">${k}</b><p>${this.state.days[k].journal}</p></div>`;
                });
                document.getElementById('j-history').innerHTML = h || "<p class='subtext'>No entries.</p>";
            },

            renderGrid: function() {
                const g = document.getElementById('grid');
                g.innerHTML = "";
                const start = new Date(this.state.startDate);
                let score = 0, count = 0;
                
                for(let i=0; i<90; i++) {
                    const d = new Date(start); d.setDate(d.getDate()+i);
                    const k = d.toISOString().split('T')[0];
                    const div = document.createElement('div');
                    div.className = 'grid-cell';
                    if(k === this.getToday()) div.style.border = "2px solid #333";
                    
                    const data = this.state.days[k];
                    if(data && d <= new Date()) {
                        let total = this.nonNegs.length + data.tasks.length;
                        let done = 0;
                        this.nonNegs.forEach(n=> data.nn[n] && done++);
                        data.tasks.forEach(x=> x.done && done++);
                        if(total > 0) {
                            div.style.background = `rgba(93,114,133,${0.3 + (done/total)*0.7})`;
                            score += (done/total); count++;
                        }
                    }
                    g.appendChild(div);
                }
                document.getElementById('score').innerText = count ? Math.round((score/count)*100)+"%" : "0%";
            }
        };

        window.onload = function() { window.app.init(); };
    </script>
</head>
<body>
    <div id="app-container">
        <div id="view-home" class="view active">
            <div style="text-align:center; margin-top:20px">
                <p class="subtext">REBIRTH JOURNEY</p>
                <h1 id="day-header">Day 1</h1>
                <div style="background:#E5E5E5; height:8px; border-radius:4px; margin:15px 0; overflow:hidden">
                    <div id="progress-fill" style="background:var(--accent-color); height:100%; width:0%"></div>
                </div>
            </div>
            <div class="card" style="text-align:center; margin-top:30px">
                <input type="text" id="identity-input" placeholder="I am becoming..." style="border:none; text-align:center; font-size:18px; color:var(--accent-color); background:transparent">
            </div>
            <button onclick="window.app.navigate('today')">Go to Today</button>
            <button class="outline" onclick="window.app.toggleBreakdown(true)">I'm not okay</button>
            <div style="text-align:center; margin-top:30px">
                <button class="text-only" onclick="window.app.toggleSettings()">‚öôÔ∏è Settings</button>
                <div id="settings-area" class="card hidden">
                    <p>Start Date:</p>
                    <input type="date" id="date-picker" onchange="window.app.updateDate(this.value)">
                </div>
            </div>
        </div>

        <div id="view-today" class="view">
            <h2>Today</h2>
            <div class="card"><h3>Non-Negotiables</h3><div id="nn-list"></div></div>
            <div class="card">
                <div style="display:flex; justify-content:space-between"><h3>Tasks</h3><button class="text-only" style="width:auto;padding:0" onclick="window.app.toggleTaskForm()">+ Add</button></div>
                <div id="task-form" class="hidden">
                    <input type="text" id="new-task-desc" placeholder="Task name...">
                    <button onclick="window.app.addTask()">Save</button>
                </div>
                <div id="task-list"></div>
            </div>
        </div>

        <div id="view-journal" class="view">
            <h2>Journal</h2>
            <div class="card"><textarea id="j-text" placeholder="Write..." oninput="window.app.saveJournal(this.value)"></textarea></div>
            <div id="j-history"></div>
        </div>

        <div id="view-grid" class="view">
            <h2>Progress</h2>
            <div class="card">
                <h1 id="score" style="color:var(--accent-color)">0%</h1>
                <div class="grid-container" id="grid"></div>
            </div>
        </div>
    </div>

    <div id="breakdown-overlay">
        <h2>Breathe.</h2>
        <div class="card" onclick="this.style.opacity=0.5">üöø Shower</div>
        <div class="card" onclick="this.style.opacity=0.5">üíß Water</div>
        <div class="card" onclick="this.style.opacity=0.5">üö∂ Walk</div>
        <button class="text-only" onclick="window.app.toggleBreakdown(false)">Return</button>
    </div>

    <nav class="navbar">
        <div class="nav-item active" onclick="window.app.navigate('home')"><span class="nav-icon">üè†</span>Home</div>
        <div class="nav-item" onclick="window.app.navigate('today')"><span class="nav-icon">‚òÄÔ∏è</span>Today</div>
        <div class="nav-item" onclick="window.app.navigate('journal')"><span class="nav-icon">‚úçÔ∏è</span>Journal</div>
        <div class="nav-item" onclick="window.app.navigate('grid')"><span class="nav-icon">üìä</span>Grid</div>
    </nav>
</body>
</html>
